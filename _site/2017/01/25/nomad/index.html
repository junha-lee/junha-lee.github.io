<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no"/>


<title>오픈소스 간단 리뷰 - nomad : 가벼운 스케쥴러, 강력한 성능</title>
<meta name="title" content="오픈소스 간단 리뷰 - nomad : 가벼운 스케쥴러, 강력한 성능" />
<meta name="author" content="niko.bellic"/>
<meta name="description" content="Introduction 서비스 스케줄러는 클러스터 내의 컴퓨팅 리소스를 관리하고 사용자 애플리케이션을 어느 호스트에서 서비스할지 결정하는 시스템 소프트웨어입니다. 컨테이너 스케줄러로는 kubernetes나 docker swarm등이 있으며, 하둡 스케줄러로는 YARN이 많이 사용됩니다. 이 글에서는 이러한 스케줄러 중 하나인 nomad를 소개합니다. nomad는 vagrant, consul, packer등의 시스템 소프트웨어로 유명한 hashicorp사의 오픈소스 소프트웨어로, 자사의 consul과 vault를 각각 service discovery와 secure storage에 사용합니다. hashicorp사는 자사의 웹페이지에서 nomad를 통해 5000개 호스트에 100만 개 컨테이너를 5분 만에 배포한 사례를 소개하고 있습니다.(Nomad Million Container Challenge) Why? Kubernetes는..."/>

<meta property="fb:app_id" content="1204347326263800"/>

<meta property="og:site_name" content="kakao 기술 블로그"/>
<meta property="og:type" content="article"/>
<meta property="og:title" content="오픈소스 간단 리뷰 - nomad : 가벼운 스케쥴러, 강력한 성능"/>
<meta property="og:description" content="Introduction 서비스 스케줄러는 클러스터 내의 컴퓨팅 리소스를 관리하고 사용자 애플리케이션을 어느 호스트에서 서비스할지 결정하는 시스템 소프트웨어입니다. 컨테이너 스케줄러로는 kubernetes나 docker swarm등이 있으며, 하둡 스케줄러로는 YARN이 많이 사용됩니다. 이 글에서는 이러한 스케줄러 중 하나인 nomad를 소개합니다. nomad는 vagrant, consul, packer등의 시스템 소프트웨어로 유명한 hashicorp사의 오픈소스 소프트웨어로, 자사의 consul과 vault를 각각 service discovery와 secure storage에 사용합니다. hashicorp사는 자사의 웹페이지에서 nomad를 통해 5000개 호스트에 100만 개 컨테이너를 5분 만에 배포한 사례를 소개하고 있습니다.(Nomad Million Container Challenge) Why? Kubernetes는..."/>
<meta property="og:url" content="http://localhost:4000/2017/01/25/nomad/"/>
<meta property="og:image" content="http://localhost:4000/assets/images/default_blog_cover.jpg"/>
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:title" content="오픈소스 간단 리뷰 - nomad : 가벼운 스케쥴러, 강력한 성능"/>
<meta name="twitter:description" content="Introduction 서비스 스케줄러는 클러스터 내의 컴퓨팅 리소스를 관리하고 사용자 애플리케이션을 어느 호스트에서 서비스할지 결정하는 시스템 소프트웨어입니다. 컨테이너 스케줄러로는 kubernetes나 docker swarm등이 있으며, 하둡 스케줄러로는 YARN이 많이 사용됩니다. 이 글에서는 이러한 스케줄러 중 하나인 nomad를 소개합니다. nomad는 vagrant, consul, packer등의 시스템 소프트웨어로 유명한 hashicorp사의 오픈소스 소프트웨어로, 자사의 consul과 vault를 각각 service discovery와 secure storage에 사용합니다. hashicorp사는 자사의 웹페이지에서 nomad를 통해 5000개 호스트에 100만 개 컨테이너를 5분 만에 배포한 사례를 소개하고 있습니다.(Nomad Million Container Challenge) Why? Kubernetes는..."/>
<meta name="twitter:label1" content="Written by"/>
<meta name="twitter:data1" content="niko.bellic"/>
<meta name="twitter:image:src" content="http://localhost:4000/assets/images/default_blog_cover.jpg"/>

<meta name="twitter:label2" content="Filed under"/>
<meta name="twitter:data2" content="nomad,consul,microservice,kubernetes"/>

<meta property="article:tag" content="nomad"/>

<meta property="article:tag" content="consul"/>

<meta property="article:tag" content="microservice"/>

<meta property="article:tag" content="kubernetes"/>



<meta property="article:published_time" content="2017-01-25T18:00:00+09:00"/>


<meta property="article:author" content="http://localhost:4000/authors/niko.bellic"/>

<link href="http://localhost:4000/rss/" rel="alternate" type="application/rss+xml" title="RSS"/>
<link href="/assets/favicon.ico" rel="shortcut icon" type="image/vnd.microsoft.icon"/>
<link href="/assets/apple-touch-icon.png" rel="apple-touch-icon" type="image/png"/>
<link href="/assets/apple-touch-icon.png" rel="apple-touch-icon-precomposed" type="image/png"/>
<link href="/assets/lib/normalize.css" rel="stylesheet" type="text/css"/>
<link href="/assets/css/monokai.css" rel="stylesheet" type="text/css"/> 
<link href="/assets/lib/magnific-popup.min.css" rel="stylesheet" type="text/css"/>
<link href="/assets/fonts/Kakao.css" rel="stylesheet" type="text/css"/> 
<link href="/assets/css/screen.css" rel="stylesheet" type="text/css"/>
<script>
    if (window.location.host.indexOf('tech.kakao.com') > -1 && window.location.protocol == "https:"){
        window.location = window.location.toString().replace(/^https:/, "http:");
    }
</script>

</head>
<body class="post-template">

<div id="header">
    <button id="menu-toggle" type="button">
        <span class="sr-only">Toggle Navigation Menu</span>
    </button>
    <button id="search-toggle" type="button">
        <span class="sr-only">Toggle Search Form</span>
    </button>
    <a id="logo" href="/">
        <span class="sr-only">KakaoTech</span>
    </a>
    <div id="search">
        <input id="search-input" type="search" placeholder="Search..." value="" />
    </div>
    <ul class="search__results" id="results-container"></ul>

    <ul id="menu" class="nav">
        <li class=" active "><a href="/">블로그</a></li>
        <li class=""><a href="/opensource/">오픈소스</a></li>
        <li class=""><a href="/openapi/">오픈API</a></li>
        <li class=""><a href="/events/">기술행사</a></li>
    </ul>
</div>
<!-- Script pointing to jekyll-search.js -->
<script src="/dest/jekyll-search.js" type="text/javascript"></script>

<script type="text/javascript">
    SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('results-container'),
        json: '/search2.json',
        searchResultTemplate: '<li><a href="{url}" title="{desc}">{title}</a></li>',
        noResultsText: '<li>No results found</li>',
        limit: 15,
        fuzzy: false,
        exclude: ['Welcome']
    })
</script><!-- #header -->



<div id="wrapper">
    <div id="navbar" class="container">
  <h5><a id="link-back" href="/">Back to Posts</a></h5>
  
<ul id="shares">
    <li class="stalk" style="display:none">
        <a id="kakao-link-btn" href="javascript:;"></a>
    </li>
    <li>
        <a id="share-kakaostory" href="javascript:shareStory('http://localhost:4000/2017/01/25/nomad/');"></a>
    </li>

    
    <li>
        <a id="share-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/2017/01/25/nomad/"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
            <span class="sr-only">Share to Facebook</span>
        </a>
    </li>
    
    
    <li>
        <a id="share-twitter"
           href="https://twitter.com/intent/tweet?text=%EC%98%A4%ED%94%88%EC%86%8C%EC%8A%A4%20%EA%B0%84%EB%8B%A8%20%EB%A6%AC%EB%B7%B0%20-%20nomad%20:%20%EA%B0%80%EB%B2%BC%EC%9A%B4%20%EC%8A%A4%EC%BC%80%EC%A5%B4%EB%9F%AC,%20%EA%B0%95%EB%A0%A5%ED%95%9C%20%EC%84%B1%EB%8A%A5&url=http://localhost:4000/2017/01/25/nomad/">
            <span class="sr-only">Share to Twitter</span>
        </a>
    </li>
    
    
    <li>
        <a id="share-google" href="https://plus.google.com/share?url=http://localhost:4000/2017/01/25/nomad/"
           onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
            <span class="sr-only">Share to Google+</span>
        </a>
    </li>
    
</ul>

</div>

<div id="cover" class="container" >
  <div>
    <h1>오픈소스 간단 리뷰 - nomad : 가벼운 스케쥴러, 강력한 성능</h1>
    <p>
      
      <a href="/tags/nomad">nomad</a>
      ,
      
      <a href="/tags/consul">consul</a>
      ,
      
      <a href="/tags/microservice">microservice</a>
      ,
      
      <a href="/tags/kubernetes">kubernetes</a>
      
      
    </p>
    


  </div>
</div>

<div id="content" class="container post" role="main">
  <div id="post-content"><h2 id="introduction">Introduction</h2>
<p>서비스 스케줄러는 클러스터 내의 컴퓨팅 리소스를 관리하고 사용자 애플리케이션을 어느 호스트에서 서비스할지 결정하는 시스템 소프트웨어입니다. 컨테이너 스케줄러로는 <a href="https://kubernetes.io">kubernetes</a>나 <a href="https://www.docker.com/products/docker-swarm">docker swarm</a>등이 있으며, 하둡 스케줄러로는 <a href="https://hadoop.apache.org/docs/current/hadoop-yarn/hadoop-yarn-site/YARN.html">YARN</a>이 많이 사용됩니다.</p>

<p>이 글에서는 이러한 스케줄러 중 하나인 <a href="https://www.nomadproject.io/">nomad</a>를 소개합니다. <a href="https://www.nomadproject.io/">nomad</a>는 <a href="https://www.vagrantup.com/">vagrant</a>, <a href="https://www.consul.io/">consul</a>, <a href="https://www.packer.io/">packer</a>등의 시스템 소프트웨어로 유명한 <a href="https://www.hashicorp.com/">hashicorp</a>사의 오픈소스 소프트웨어로, 자사의 <a href="https://www.consul.io/">consul</a>과 <a href="https://www.vaultproject.io/">vault</a>를 각각 service discovery와 secure storage에 사용합니다. hashicorp사는 자사의 웹페이지에서 nomad를 통해 5000개 호스트에 100만 개 컨테이너를 5분 만에 배포한 사례를 소개하고 있습니다.(<a href="https://www.hashicorp.com/c1m.html">Nomad Million Container Challenge</a>)</p>

<h2 id="why">Why?</h2>
<p>Kubernetes는 <a href="https://www.cncf.io/">CNCF(Cloud Native Computing Foundation)</a>에서 개발을 주도하고 있으며, 현재 가장 인기있는 container orchestrator로서 안정성과 성능이 뛰어납니다. (최근 오픈소스화된 <a href="https://github.com/kakao/cite">cite</a>도 Kubernetes를 사용합니다.) 하지만 설계의 특성상 몇가지 단점들이 있습니다.</p>

<p>Kubernetes의 특징 중 하나는 전체 시스템을 “직접” 관리하는 것입니다. 이러한 설계로 인해 Kubernetes에서 pluggable하게 설계하지 않은 기능은 재컴파일하지 않는 이상 구현하기 어려운데요, 예를 들면 cloud provider 추가, volume type 추가 등이 있습니다.
최근에는 FlexVolume(https://kubernetes.io/docs/user-guide/volumes/#flexvolume)등의 재컴파일 없이 확장 가능한 모델도 추가되고 있습니다.</p>

<p>또한, Kubernetes는 기반 인프라가 갖춰져 있어야만 사용할 수 있습니다. Kubernetes 설치에서 가장 난해한 부분 중 하나는 네트워킹으로, Kubernetes는 모든 Pod이 서로 중복되지 않고 routable한 IP를 가져야만 서비스할 수 있습니다. 이러한 요구사항을 따르기 위한 여러 플러그인들이 개발되어 있지만 대부분 각 호스트에 설치된 docker daemon의 구동 옵션을 조절(<a href="https://github.com/coreos/flannel">flannel</a>)하거나 컨테이너 구동 후 nsenter를 통해 직접 network stack을 수정(<a href="http://projectcalico.org/">calico</a>)하는 등의 저수준 해킹에 가까운 방식을 사용합니다.</p>

<p>반면 nomad는 가벼운 리소스 관리자와 스케줄러로만 이루어져 있기 때문에 구조적으로 단순하고 성능이 빠르며 이해하기 쉽습니다. 또한, docker나 rkt 등의 컨테이너 드라이버 외에 fork/exec, qemu, java, LXC 등의 드라이버도 활용할 수 있습니다.</p>

<p>java로 만든 서비스는 JAR나 WAR형태로 패키징 되어 JVM위에서 구동되며, 맞는 버전의 JVM만 있으면 어디에서나 구동된다는 점에서 컨테이너와 유사합니다.(JNI가 필요한 경우는 논외로 합니다.) 이러한 JVM기반 서비스는 nomad를 통해 컨테이너화 하지 않고도 orchestration을 할 수 있습니다.</p>

<p>이 글에서는 Java 드라이버의 활용에 대해 다루며, nomad와 다른 클러스터 관리자/스케줄러와의 차이점은 <a href="https://www.nomadproject.io/intro/vs/index.html">Nomad vs. Other Software</a> 에서 자세하게 살펴보실 수 있습니다.</p>

<ul>
  <li><a href="https://www.nomadproject.io/intro/vs/swarm.html">Nomad vs. Docker Swarm</a></li>
  <li><a href="https://www.nomadproject.io/intro/vs/mesos.html">Nomad vs. Mesos with Aurora, Marathon</a></li>
  <li><a href="https://www.nomadproject.io/intro/vs/kubernetes.html">Nomad vs. Kubernetes</a></li>
</ul>

<h2 id="job-spec">Job Spec</h2>
<p>이 절에서는 nomad에서 JVM기반 프로세스를 구동하는 방법에 대해 간단한  웹서비스 예제를 통해 살펴보겠습니다.</p>

<p>nomad의 Java Driver는 주어진 Job Spec에 따라 JAVA_HOME을 선택하고 cgroups, namespaces, chroot 등으로 job을 isolation시켜서 구동합니다.</p>

<p>nomad의 <a href="https://www.nomadproject.io/docs/drivers/java.html">Java Driver</a> 스펙에는 jar_path, args, jvm_options등을 지정하며, 부가적으로 구동될 JVM의 버전을 선택할 수 있습니다.</p>

<p>아래 Job Spec은 가상의 fatJAR 배포 서버 <a href="https://internal.file.server">https://internal.file.server</a>에서 다운로드할 수 있는 java-sample-all.jar에 대해 명시하고 있습니다. 실제 운영 시에는 jenkins의 artifact를 사용하여 손쉽게 CI서버/배포서버를 구축할 수 있습니다.</p>

<ul>
  <li>Job Spec 생성 : docker기반 redis서비스를 명시한 example.nomad파일 생성</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nomad init
</code></pre></div></div>

<ul>
  <li>Job Spec 수정 : java driver로 변경, artifact source지정</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">job "hello" {</span>
  <span class="s">datacenters = ["dc1"]</span>
  <span class="s">type = "service"</span>
  
  <span class="s">group "helloGroup" {</span>
    <span class="s">count = 1</span>

    <span class="s">task "helloTask" {</span>
      <span class="s">driver = "java"</span>

      <span class="s">config {</span>
        <span class="s">jar_path = "local/java-sample-all.jar"</span>
        <span class="s">jvm_options = ["-Xmx2048m","-Xms256m"]</span>
      <span class="s">}</span>
      <span class="s">resources {</span>
        <span class="s">network {</span>
          <span class="s">mbits = 10</span>
          <span class="s">port "http" {}</span>
        <span class="s">}</span>
      <span class="s">}</span>
      <span class="s">service {</span>
        <span class="s">name = "hello"</span>
        <span class="s">tags = ["hello"]</span>
        <span class="s">port = "http"</span>
        <span class="s">check {</span>
          <span class="s">name     = "alive"</span>
          <span class="s">type     = "tcp"</span>
          <span class="s">interval = "10s"</span>
          <span class="s">timeout  = "2s"</span>
        <span class="s">}</span>
      <span class="s">}</span>
      <span class="s">artifact {</span>
        <span class="s">source = "https://internal.file.server/hello.jar"</span>

        <span class="s">options {</span>
        <span class="s">checksum = "md5:123445555555555"</span>
        <span class="s">}</span>
      <span class="s">}</span>
    <span class="s">}</span>
  <span class="s">}</span>
<span class="err">}</span>
</code></pre></div></div>

<h2 id="service">Service</h2>
<p>nomad는 서비스 실행 시 호스트에서 사용되지 않는 임의의 포트번호를 서비스에 할당한 후 런타임에 환경변수로 NOMAD_PORT_[포트이름]를 전달합니다. 각 서비스는 실행 시 전달받은 포트를 사용하여 구동됩니다.</p>

<p>아래는 <a href="http://sparkjava.com/">sparkjava</a>를 이용한 간단한 예제입니다. 코드에서 listening port의 기본값으로 4567을 지정한 후 NOMAD_PORT_http가 있는 경우 해당 환경변수의 값으로 변경하였습니다.</p>

<ul>
  <li>src/main/java/HelloWorld.java</li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">static</span> <span class="n">spark</span><span class="o">.</span><span class="na">Spark</span><span class="o">.*;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HelloWorld</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">4567</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">getenv</span><span class="o">(</span><span class="s">"NOMAD_PORT_http"</span><span class="o">)</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
            <span class="n">port</span> <span class="o">=</span> <span class="n">Integer</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">getenv</span><span class="o">(</span><span class="s">"NOMAD_PORT_http"</span><span class="o">));</span>
        <span class="n">port</span><span class="o">(</span><span class="n">port</span><span class="o">);</span>
        <span class="n">get</span><span class="o">(</span><span class="s">"/hello"</span><span class="o">,</span> <span class="o">(</span><span class="n">req</span><span class="o">,</span> <span class="n">res</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="s">"Hello World"</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>빌드 스크립트에서는 fatJAR로 만들기 위해 <a href="https://github.com/johnrengelman/shadow">shadowjar plugin</a>을 사용하였습니다.</p>

<ul>
  <li>build.gradle</li>
</ul>

<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">plugins</span> <span class="o">{</span>
  <span class="n">id</span> <span class="s1">'com.github.johnrengelman.shadow'</span> <span class="n">version</span> <span class="s1">'1.2.4'</span>
<span class="o">}</span>

<span class="n">apply</span> <span class="nl">plugin:</span> <span class="s1">'java'</span>
<span class="n">apply</span> <span class="nl">plugin:</span> <span class="s1">'application'</span>

<span class="n">mainClassName</span> <span class="o">=</span> <span class="s1">'HelloWorld'</span>

<span class="n">repositories</span> <span class="o">{</span>
    <span class="n">jcenter</span><span class="o">()</span>
<span class="o">}</span>

<span class="n">dependencies</span> <span class="o">{</span>
    <span class="n">compile</span> <span class="s1">'org.slf4j:slf4j-api:1.7.22'</span>
    <span class="n">compile</span> <span class="s1">'org.slf4j:slf4j-simple:1.7.22'</span>
    <span class="n">compile</span> <span class="s2">"com.sparkjava:spark-core:2.5.4"</span>
    <span class="n">testCompile</span> <span class="s1">'junit:junit:4.12'</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="running-a-job">Running a Job</h2>

<p>작업을 구동하려면 nomad run명령을 사용합니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nomad run example.nomad
</code></pre></div></div>

<p>실행결과를 보려면 nomad status 명령을 사용합니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nomad status hello
ID          <span class="o">=</span> hello
Name        <span class="o">=</span> hello
Type        <span class="o">=</span> service
Priority    <span class="o">=</span> 50
Datacenters <span class="o">=</span> dc1
Status      <span class="o">=</span> running
Periodic    <span class="o">=</span> <span class="nb">false

</span>Summary
Task Group  Queued  Starting  Running  Failed  Complete  Lost
helloGroup  0       0         1        0       7         0

Allocations
ID        Eval ID   Node ID   Task Group  Desired  Status   Created At
e7a4aa6e  f19cf697  d084d0ce  helloGroup  run      running  01/20/17 19:37:26 KST
</code></pre></div></div>

<p>서비스가 클러스터 내에 할당된 정보를 보려면 nomad alloc-status명령을 사용합니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nomad alloc-status e7a4aa6e
ID                  <span class="o">=</span> e7a4aa6e
Eval ID             <span class="o">=</span> f19cf697
Name                <span class="o">=</span> hello.helloGroup[0]
Node ID             <span class="o">=</span> d084d0ce
Job ID              <span class="o">=</span> hello
Client Status       <span class="o">=</span> running
Client Description  <span class="o">=</span> &lt;none&gt;
Desired Status      <span class="o">=</span> run
Desired Description <span class="o">=</span> &lt;none&gt;
Created At          <span class="o">=</span> 01/20/17 19:37:26 KST

Task <span class="s2">"helloTask"</span> is <span class="s2">"running"</span>
Task Resources
CPU        Memory          Disk  IOPS  Addresses
9/500 MHz  40 MiB/256 MiB  0 B   0     http: <span class="o">[</span>호스트 IP]:[할당된 임의 포트 48367]

Recent Events:
Time                   Type                   Description
01/20/17 19:37:31 KST  Started                Task started by client
01/20/17 19:37:26 KST  Downloading Artifacts  Client is downloading artifacts
01/20/17 19:37:26 KST  Received               Task received by client
</code></pre></div></div>

<p>서비스 로그는 nomad logs명령으로 볼 수 있습니다. 아래에서는 slf4j-simple이 stderr로 로그를 출력하기 때문에 -stderr옵션을 추가하였습니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nomad logs <span class="nt">-stderr</span> e7a4aa6e
<span class="o">[</span>Thread-0] INFO org.eclipse.jetty.util.log - Logging initialized @236ms
<span class="o">[</span>Thread-0] INFO spark.embeddedserver.jetty.EmbeddedJettyServer - <span class="o">==</span> Spark has ignited ...
<span class="o">[</span>Thread-0] INFO spark.embeddedserver.jetty.EmbeddedJettyServer - <span class="o">&gt;&gt;</span> Listening on 0.0.0.0:48367
<span class="o">[</span>Thread-0] INFO org.eclipse.jetty.server.Server - jetty-9.3.z-SNAPSHOT
<span class="o">[</span>Thread-0] INFO org.eclipse.jetty.server.ServerConnector - Started ServerConnector@245acdf6<span class="o">{</span>HTTP/1.1,[http/1.1]<span class="o">}{</span>0.0.0.0:48367<span class="o">}</span>
<span class="o">[</span>Thread-0] INFO org.eclipse.jetty.server.Server - Started @365ms
<span class="o">[</span>qtp1878800355-18] INFO spark.http.matching.MatcherFilter - The requested route <span class="o">[</span>/] has not been mapped <span class="k">in </span>Spark <span class="k">for </span>Accept: <span class="o">[</span><span class="k">*</span>/<span class="k">*</span><span class="o">]</span>
</code></pre></div></div>

<h2 id="modifying-a-job">Modifying a Job</h2>
<p>배포나 롤백 등의 서비스 수정은 plan과 run 두 단계를 거칩니다. plan은 변경된 내역이 클러스터에 어떻게 적용될지 보여주며, run은 실제로 변경을 수행합니다.</p>

<p>Job Spec에서 hello서비스의 인스턴스를 3개로 늘려 보겠습니다.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">job "hello" {</span>
  <span class="s">group "helloGroup" {</span>
    <span class="s">count = 3</span>
</code></pre></div></div>

<p>변경된 Job Spec을 plan명령으로 확인합니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nomad plan example.nomad 
+/- Job: <span class="s2">"hello"</span>
    Datacenters <span class="o">{</span>
  Datacenters: <span class="s2">"dc1"</span>
<span class="o">}</span>
+/- Task Group: <span class="s2">"helloGroup"</span> <span class="o">(</span>2 create, 1 create/destroy update<span class="o">)</span>
  +/- Count: <span class="s2">"1"</span> <span class="o">=&gt;</span> <span class="s2">"3"</span> <span class="o">(</span>forces create<span class="o">)</span>
  +/- Task: <span class="s2">"helloTask"</span> <span class="o">(</span>forces create/destroy update<span class="o">)</span>
    - Artifact <span class="o">{</span>
      - GetterSource: <span class="s2">"https://internal.file.server/hello.jar"</span>
      - RelativeDest: <span class="s2">"local/"</span>
    <span class="o">}</span>
    + Service <span class="o">{</span>
      + Name:      <span class="s2">"hello"</span>
      + PortLabel: <span class="s2">"http"</span>
      + Check <span class="o">{</span>
          Command:       <span class="s2">""</span>
          InitialStatus: <span class="s2">""</span>
        + Interval:      <span class="s2">"10000000000"</span>
        + Name:          <span class="s2">"alive"</span>
          Path:          <span class="s2">""</span>
          PortLabel:     <span class="s2">""</span>
          Protocol:      <span class="s2">""</span>
        + Timeout:       <span class="s2">"2000000000"</span>
        + Type:          <span class="s2">"tcp"</span>
      <span class="o">}</span>
    <span class="o">}</span>

Scheduler dry-run:
- All tasks successfully allocated.

Job Modify Index: 4617
To submit the job with version verification run:

nomad run <span class="nt">-check-index</span> 4617 example.nomad

When running the job with the check-index flag, the job will only be run <span class="k">if </span>the
server side version matches the job modify index returned. If the index has
changed, another user has modified the job and the plan<span class="s1">'s results are
potentially invalid.
</span></code></pre></div></div>

<p>변경내역을 run명령으로 적용합니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nomad run <span class="nt">-check-index</span> 4617 example.nomad
<span class="o">==&gt;</span> Monitoring evaluation <span class="s2">"a92b41cc"</span>
    Evaluation triggered by job <span class="s2">"hello"</span>
    Allocation <span class="s2">"100f9aac"</span> created: node <span class="s2">"d084d0ce"</span>, group <span class="s2">"helloGroup"</span>
    Evaluation status changed: <span class="s2">"pending"</span> -&gt; <span class="s2">"complete"</span>
<span class="o">==&gt;</span> Evaluation <span class="s2">"a92b41cc"</span> finished with status <span class="s2">"complete"</span>
<span class="o">==&gt;</span> Monitoring evaluation <span class="s2">"aba7825f"</span>
    Evaluation triggered by job <span class="s2">"hello"</span>
    Allocation <span class="s2">"1f08bfd7"</span> created: node <span class="s2">"2002f3dd"</span>, group <span class="s2">"helloGroup"</span>
    Evaluation status changed: <span class="s2">"pending"</span> -&gt; <span class="s2">"complete"</span>
<span class="o">==&gt;</span> Evaluation <span class="s2">"aba7825f"</span> finished with status <span class="s2">"complete"</span>
<span class="o">==&gt;</span> Monitoring next evaluation <span class="s2">"1418a2ab"</span> <span class="k">in </span>10s
<span class="o">==&gt;</span> Monitoring evaluation <span class="s2">"1418a2ab"</span>
    Evaluation triggered by job <span class="s2">"hello"</span>
    Allocation <span class="s2">"376e1895"</span> created: node <span class="s2">"0593bcf8"</span>, group <span class="s2">"helloGroup"</span>
    Evaluation status changed: <span class="s2">"pending"</span> -&gt; <span class="s2">"complete"</span>
<span class="o">==&gt;</span> Evaluation <span class="s2">"1418a2ab"</span> finished with status <span class="s2">"complete"</span>
</code></pre></div></div>

<p>변경된 서비스를 status명령으로 확인합니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>nomad status hello
ID          <span class="o">=</span> hello
Name        <span class="o">=</span> hello
Type        <span class="o">=</span> service
Priority    <span class="o">=</span> 50
Datacenters <span class="o">=</span> dc1
Status      <span class="o">=</span> running
Periodic    <span class="o">=</span> <span class="nb">false

</span>Summary
Task Group  Queued  Starting  Running  Failed  Complete  Lost
helloGroup  0       0         3        0       11        0

Allocations
ID        Eval ID   Node ID   Task Group  Desired  Status    Created At
376e1895  1418a2ab  0593bcf8  helloGroup  run      running   01/25/17 16:11:35 KST
1f08bfd7  aba7825f  2002f3dd  helloGroup  run      running   01/25/17 16:11:25 KST
100f9aac  a92b41cc  d084d0ce  helloGroup  run      running   01/25/17 16:11:15 KST
e7a4aa6e  f19cf697  d084d0ce  helloGroup  stop     <span class="nb">complete  </span>01/20/17 19:37:26 KST
</code></pre></div></div>

<p>구동된 서비스는 consul에 등록됩니다.</p>

<p><img src="/files/nomad_consul_service.png" alt="Nomad Consul Service" /></p>

<h2 id="web-ui--hashi-ui">Web UI : hashi-ui</h2>
<p>nomad의 web frontend는 <a href="https://www.hashicorp.com/">hashicorp</a>에서 공식적으로 지원하는 <a href="https://www.hashicorp.com/atlas.html">atlas</a>와 오픈소스인 <a href="https://github.com/jippi/hashi-ui">hashi-ui</a>가 있습니다. 여기서는 hashi-ui에 대해 알아보겠습니다.</p>

<p>hashi-ui는 consul과 nomad의 오픈소스 web frontend입니다. consul에 내장된 ui와 가장 큰 차이점은 websocket을 이용한 실시간 업데이트입니다.</p>

<p><img src="/files/nomad_cluster_overview.png" alt="Nomad Cluster Overview" /></p>

<p><img src="/files/nomad_jobs.png" alt="Nomad Jobs" /></p>

<p><img src="/files/nomad_alloc_status.png" alt="Nomad Allocations" /></p>

<p><img src="/files/nomad_servers.png" alt="Nomad Servers" /></p>

<h2 id="conclusion">Conclusion</h2>
<p>nomad는 클러스터를 구성하는 각각의 역할을 분리하고 스케줄링에만 집중함으로써 간결하고 빠른 아키텍처를 만들었습니다. 단순하기 때문에 비록 구현된 기능의 수는 Kubernetes보다 적지만 성능 측면에서는 Kubernetes보다 더 뛰어나며, 필요한 기능을 추가하기도 더 쉽습니다.</p>

<p>이 글이 서비스 오케스트레이션 솔루션 선택에 도움이 되었으면 합니다. 감사합니다.</p>

<h2 id="references">References</h2>

<ul>
  <li>nomad : <a href="https://www.nomadproject.io/">https://www.nomadproject.io/</a></li>
  <li>consul : <a href="https://www.consul.io/">https://www.consul.io/</a></li>
  <li>kubernetes : <a href="https://kubernetes.io">https://kubernetes.io</a></li>
  <li>sparkjava : <a href="http://sparkjava.com/">http://sparkjava.com/</a></li>
</ul>
</div>
  <div id="post-footer">
    
    <a id="post-author" href="/authors/niko.bellic/">
      <div id="author-image" style="background-image:url(/files/authors/niko.bellic.jpg);">
        <span class="sr-only">niko.bellic's profile image</span>
      </div>
      <p id="author-name">niko.bellic</p>
    </a>
    <p id="post-date">2017-01-25 18:00</p>
    <a id="post-more" href="/authors/niko.bellic/">
      <span>Read more posts by this author</span>
    </a>
  </div>
</div>

<div class="container" style="margin-top:25px; padding:0px">
  <a href="https://www.welcomekakao.com" target="_blank"><img src="/files/career2020.jpg" style="width:100%;"></a>
</div>

<div id="post-links" class="container">
  
  
  <div id="post-prev" style="background-image: url(/files/covers/kage-idc.jpg);" >
    <div>
      <h3><a href="/2017/01/12/kage/">대규모 분산 스토리지(Kage)의 발전과정</a></h3>
      <p>YOU MIGHT ENJOY</p>
    </div>
  </div>
  
  
  
  <div id="post-next" >
    <div>
      <h3><a href="/2017/07/12/opensource-7-cmux/">kakao의 오픈소스 Ep7 - CMUX: CLI에 날개를 달자!</a></h3>
      <p>NEXT POST</p>
    </div>
  </div>
  
</div>

<div id="lightbox">
  <div id="lightbox-image"></div>
</div>

    <div class="clearfix"></div>

    <a href="#" id="back-to-top"></a>
</div>

<div id="footer" class="container-fluid">
    <ul id="links">
        
        <li>
            <a id="link-github" href="http://github.com/kakao" target="_blank">
                <span class="sr-only">github</span>
            </a>
        </li>
        
        
        <li>
            <a id="link-facebook" href="http://facebook.com/nkakao" target="_blank">
                <span class="sr-only">facebook</span>
            </a>
        </li>
        
        
        <li>
            <a id="link-twitter" href="http://twitter.com/kakaodev" target="_blank">
                <span class="sr-only">twitter</span>
            </a>
        </li>
        
        <li>
            <a id="link-rss" href="/rss" target="_blank">
                <span class="sr-only">rss</span>
            </a>
        </li>
    </ul>
    <ul id="footer-menu">
        <li><a href="//www.kakaocorp.com">Kakao</a></li>
        <li><a href="//careers.kakao.com/jobs">Jobs</a></li>
        <li><a href="//privacy.kakaocorp.com">Privacy</a></li>
    </ul>
    <p id="copyright">
        <a href="//www.kakaocorp.com">Copyright &copy; Kakao Corp.</a>
        All rights reserved.
    </p>
</div><!--#footer-->


<script src="/assets/lib/jquery-1.12.0.min.js"></script>
<script src="/assets/lib/jquery.magnific-popup.min.js"></script>
<script src="/assets/js/index.js"></script>
<script src="//developers.kakao.com/sdk/js/kakao.min.js"></script>


<script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date();
        a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'UA-72007721-1', 'auto');
    ga('send', 'pageview');
</script>




    <script type='text/javascript'>
   //<![CDATA[
    // 사용할 앱의 JavaScript 키를 설정해 주세요.
    //Kakao.init('65d48e116d8b9409e08960c4800c3017');
    function shareStory(abs_page_url) {
        Kakao.Story.share({
            url: abs_page_url,
            text: '카카오 기술블로그 #개발자 #카카오'
        });
    }
    //]]>
</script>

    
    <script>
window.fbAsyncInit = function() {
  FB.init({
    appId      : '1204347326263800',
    xfbml      : true,
    version    : 'v2.7'
  });
};

(function(d, s, id){
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
</script>

    

    
    <script>!function (d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https';
        if (!d.getElementById(id)) {
            js = d.createElement(s);
            js.id = id;
            js.src = p + '://platform.twitter.com/widgets.js';
            fjs.parentNode.insertBefore(js, fjs);
        }
    }(document, 'script', 'twitter-wjs');
</script>

    

    
    <script src="https://apis.google.com/js/platform.js" async defer>
    {
        lang: 'ko'
    }
</script>

    

</body>
</html>
