<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0,user-scalable=no"/>


<title>kakao의 오픈소스 Ep7 - CMUX: CLI에 날개를 달자!</title>
<meta name="title" content="kakao의 오픈소스 Ep7 - CMUX: CLI에 날개를 달자!" />
<meta name="author" content="jon.kwon"/>
<meta name="description" content="“카카오의 오픈소스를 소개합니다” 일곱 번째는 jon.kwon과 동료들이 개발한 CMUX입니다. CMUX는 Cloudera Manager 기반의 하둡 클러스터를 관리하는데 필요한 대화형 커맨드라인 인터페이스 도구들을 제공합니다. CMUX의 아이디어를 참고해 보세요. 여러분의 커맨드라인에 날개를 달 수 있을 것입니다. 카카오의 하둡 엔지니어링 파트에서는 CMUX를 이렇게 사용합니다. 수천 대의 하둡 클러스터의 정보를 빠르게 검색하여 필요한 정보를 조회하기도 하고, 특정 조건으로 검색한 노드에 SSH 로그인하여 병렬 작업을 하거나, 특정 조건으로 검색한 관리자 웹페이지를 열어보기도 합니다. 특정 조건으로 검색한 노드에만 명령어를 실행할 수도 있습니다...."/>

<meta property="fb:app_id" content="1204347326263800"/>

<meta property="og:site_name" content="kakao 기술 블로그"/>
<meta property="og:type" content="article"/>
<meta property="og:title" content="kakao의 오픈소스 Ep7 - CMUX: CLI에 날개를 달자!"/>
<meta property="og:description" content="“카카오의 오픈소스를 소개합니다” 일곱 번째는 jon.kwon과 동료들이 개발한 CMUX입니다. CMUX는 Cloudera Manager 기반의 하둡 클러스터를 관리하는데 필요한 대화형 커맨드라인 인터페이스 도구들을 제공합니다. CMUX의 아이디어를 참고해 보세요. 여러분의 커맨드라인에 날개를 달 수 있을 것입니다. 카카오의 하둡 엔지니어링 파트에서는 CMUX를 이렇게 사용합니다. 수천 대의 하둡 클러스터의 정보를 빠르게 검색하여 필요한 정보를 조회하기도 하고, 특정 조건으로 검색한 노드에 SSH 로그인하여 병렬 작업을 하거나, 특정 조건으로 검색한 관리자 웹페이지를 열어보기도 합니다. 특정 조건으로 검색한 노드에만 명령어를 실행할 수도 있습니다...."/>
<meta property="og:url" content="http://localhost:4000/2017/07/12/opensource-7-cmux/"/>
<meta property="og:image" content="http://localhost:4000/assets/images/default_blog_cover.jpg"/>
<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:title" content="kakao의 오픈소스 Ep7 - CMUX: CLI에 날개를 달자!"/>
<meta name="twitter:description" content="“카카오의 오픈소스를 소개합니다” 일곱 번째는 jon.kwon과 동료들이 개발한 CMUX입니다. CMUX는 Cloudera Manager 기반의 하둡 클러스터를 관리하는데 필요한 대화형 커맨드라인 인터페이스 도구들을 제공합니다. CMUX의 아이디어를 참고해 보세요. 여러분의 커맨드라인에 날개를 달 수 있을 것입니다. 카카오의 하둡 엔지니어링 파트에서는 CMUX를 이렇게 사용합니다. 수천 대의 하둡 클러스터의 정보를 빠르게 검색하여 필요한 정보를 조회하기도 하고, 특정 조건으로 검색한 노드에 SSH 로그인하여 병렬 작업을 하거나, 특정 조건으로 검색한 관리자 웹페이지를 열어보기도 합니다. 특정 조건으로 검색한 노드에만 명령어를 실행할 수도 있습니다...."/>
<meta name="twitter:label1" content="Written by"/>
<meta name="twitter:data1" content="jon.kwon"/>
<meta name="twitter:image:src" content="http://localhost:4000/assets/images/default_blog_cover.jpg"/>

<meta name="twitter:label2" content="Filed under"/>
<meta name="twitter:data2" content="opensource,cmux,hadoop,cloudera-manager,tmux,fzf,ruby"/>

<meta property="article:tag" content="opensource"/>

<meta property="article:tag" content="cmux"/>

<meta property="article:tag" content="hadoop"/>

<meta property="article:tag" content="cloudera-manager"/>

<meta property="article:tag" content="tmux"/>

<meta property="article:tag" content="fzf"/>

<meta property="article:tag" content="ruby"/>



<meta property="article:published_time" content="2017-07-12T00:00:00+09:00"/>


<meta property="article:author" content="http://localhost:4000/authors/jon.kwon"/>

<link href="http://localhost:4000/rss/" rel="alternate" type="application/rss+xml" title="RSS"/>
<link href="/assets/favicon.ico" rel="shortcut icon" type="image/vnd.microsoft.icon"/>
<link href="/assets/apple-touch-icon.png" rel="apple-touch-icon" type="image/png"/>
<link href="/assets/apple-touch-icon.png" rel="apple-touch-icon-precomposed" type="image/png"/>
<link href="/assets/lib/normalize.css" rel="stylesheet" type="text/css"/>
<link href="/assets/css/monokai.css" rel="stylesheet" type="text/css"/> 
<link href="/assets/lib/magnific-popup.min.css" rel="stylesheet" type="text/css"/>
<link href="/assets/fonts/Kakao.css" rel="stylesheet" type="text/css"/> 
<link href="/assets/css/screen.css" rel="stylesheet" type="text/css"/>
<script>
    if (window.location.host.indexOf('tech.kakao.com') > -1 && window.location.protocol == "https:"){
        window.location = window.location.toString().replace(/^https:/, "http:");
    }
</script>

</head>
<body class="post-template">

<div id="header">
    <button id="menu-toggle" type="button">
        <span class="sr-only">Toggle Navigation Menu</span>
    </button>
    <button id="search-toggle" type="button">
        <span class="sr-only">Toggle Search Form</span>
    </button>
    <a id="logo" href="/">
        <span class="sr-only">KakaoTech</span>
    </a>
    <div id="search">
        <input id="search-input" type="search" placeholder="Search..." value="" />
    </div>
    <ul class="search__results" id="results-container"></ul>

    <ul id="menu" class="nav">
        <li class=" active "><a href="/">블로그</a></li>
        <li class=""><a href="/opensource/">오픈소스</a></li>
        <li class=""><a href="/openapi/">오픈API</a></li>
        <li class=""><a href="/events/">기술행사</a></li>
    </ul>
</div>
<!-- Script pointing to jekyll-search.js -->
<script src="/dest/jekyll-search.js" type="text/javascript"></script>

<script type="text/javascript">
    SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('results-container'),
        json: '/search2.json',
        searchResultTemplate: '<li><a href="{url}" title="{desc}">{title}</a></li>',
        noResultsText: '<li>No results found</li>',
        limit: 15,
        fuzzy: false,
        exclude: ['Welcome']
    })
</script><!-- #header -->



<div id="wrapper">
    <div id="navbar" class="container">
  <h5><a id="link-back" href="/">Back to Posts</a></h5>
  
<ul id="shares">
    <li class="stalk" style="display:none">
        <a id="kakao-link-btn" href="javascript:;"></a>
    </li>
    <li>
        <a id="share-kakaostory" href="javascript:shareStory('http://localhost:4000/2017/07/12/opensource-7-cmux/');"></a>
    </li>

    
    <li>
        <a id="share-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://localhost:4000/2017/07/12/opensource-7-cmux/"
           onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
            <span class="sr-only">Share to Facebook</span>
        </a>
    </li>
    
    
    <li>
        <a id="share-twitter"
           href="https://twitter.com/intent/tweet?text=kakao%EC%9D%98%20%EC%98%A4%ED%94%88%EC%86%8C%EC%8A%A4%20Ep7%20-%20CMUX:%20CLI%EC%97%90%20%EB%82%A0%EA%B0%9C%EB%A5%BC%20%EB%8B%AC%EC%9E%90!&url=http://localhost:4000/2017/07/12/opensource-7-cmux/">
            <span class="sr-only">Share to Twitter</span>
        </a>
    </li>
    
    
    <li>
        <a id="share-google" href="https://plus.google.com/share?url=http://localhost:4000/2017/07/12/opensource-7-cmux/"
           onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
            <span class="sr-only">Share to Google+</span>
        </a>
    </li>
    
</ul>

</div>

<div id="cover" class="container" >
  <div>
    <h1>kakao의 오픈소스 Ep7 - CMUX: CLI에 날개를 달자!</h1>
    <p>
      
      <a href="/tags/opensource">opensource</a>
      ,
      
      <a href="/tags/cmux">cmux</a>
      ,
      
      <a href="/tags/hadoop">hadoop</a>
      ,
      
      <a href="/tags/cloudera-manager">cloudera-manager</a>
      ,
      
      <a href="/tags/tmux">tmux</a>
      ,
      
      <a href="/tags/fzf">fzf</a>
      ,
      
      <a href="/tags/ruby">ruby</a>
      
      
    </p>
    


  </div>
</div>

<div id="content" class="container post" role="main">
  <div id="post-content"><p><a id="forkme" href="https://github.com/kakao/cmux"></a></p>

<blockquote>
  <p>“카카오의 오픈소스를 소개합니다” 일곱 번째는 <a href="http://github.com/jonkwon">jon.kwon</a>과 동료들이 개발한 <strong>CMUX</strong>입니다.</p>

  <p><a href="https://github.com/kakao/cmux">CMUX</a>는 <a href="https://www.cloudera.com/products/product-components/cloudera-manager.html?">Cloudera Manager</a> 기반의 하둡 클러스터를 관리하는데 필요한 대화형 커맨드라인 인터페이스 도구들을 제공합니다.</p>

  <p>CMUX의 아이디어를 참고해 보세요. 여러분의 커맨드라인에 날개를 달 수 있을 것입니다.</p>
</blockquote>

<h2 id="카카오의-하둡-엔지니어링-파트에서는-cmux를-이렇게-사용합니다">카카오의 하둡 엔지니어링 파트에서는 CMUX를 이렇게 사용합니다.</h2>

<p>수천 대의 하둡 클러스터의 정보를 빠르게 검색하여 필요한 정보를 조회하기도 하고,</p>

<p><img src="http://api-metakage-4misc.kakao.com/dn/hadoopeng/cmux/cmux_list-hosts.gif" alt="cmux lh" /></p>

<p>특정 조건으로 검색한 노드에 SSH 로그인하여 병렬 작업을 하거나,</p>

<p><img src="http://api-metakage-4misc.kakao.com/dn/hadoopeng/cmux/cmux_ssh-cm-hosts.gif" alt="cmux ssh" /></p>

<p>특정 조건으로 검색한 관리자 웹페이지를 열어보기도 합니다.</p>

<p><img src="http://api-metakage-4misc.kakao.com/dn/hadoopeng/cmux/cmux_web-service.gif" alt="cmux websvc" /></p>

<p><img src="http://api-metakage-4misc.kakao.com/dn/hadoopeng/cmux/cmux_web-cm.gif" alt="cmux webcm" /></p>

<p>특정 조건으로 검색한 노드에만 명령어를 실행할 수도 있습니다.</p>

<p><img src="http://api-metakage-4misc.kakao.com/dn/hadoopeng/cmux/cmux_manage-cludera-scm-agent.gif" alt="cmux scmagent" /></p>

<p>필요하면 외부 툴을 실행할 수도 있죠.</p>

<p><img src="http://api-metakage-4misc.kakao.com/dn/hadoopeng/cmux/cmux_hri.gif" alt="cmux hri" /></p>

<p>조금만 여유가 있다면 <a href="https://github.com/kakao/cmux/wiki/The-steps-to-Rolling-Restart-Roles">Rolling restart role</a>처럼 아주 복잡한 유지 보수 작업이나 배치 작업을 만들어서 사용할 수도 있습니다.</p>

<p>지금부터 이런 것들을 가능하게 한 CMUX의 아이디어를 소개해 드리겠습니다.</p>

<h2 id="cmux의-작업-흐름">CMUX의 작업 흐름</h2>

<p>CMUX는 크게 4단계의 작업 흐름으로 구성된 명령어 집합입니다.</p>

<p><img src="/files/cmux.png" alt="" /></p>

<h3 id="입력-단계">입력 단계</h3>
<p>입력 소스는 파일, 파이프라인, API 등 여러분이 상상할 수 있는 다양한 형태가 될 수 있습니다. CMUX에서는 Cloudera Manager의 REST API와 카카오의 인프라 자원을 조회하는 API를 주로 사용합니다.</p>

<h3 id="검색--필터-단계">검색 / 필터 단계</h3>
<p>CMUX의 꽃에 해당되는 부분입니다. 빔(Vim)신이라고 불리는 카카오의 <a href="https://github.com/junegunn">jg.choi</a>이 만드신 <a href="https://github.com/junegunn/fzf">FZF</a>라는 커맨드라인 검색 도구를 사용하여, 원하는 조건으로 입력을 검색하고 결과를 걸러냅니다.</p>

<h3 id="명령어-생성-단계">명령어 생성 단계</h3>
<p>걸러진 결과를 바탕으로 명령어 또는 명령어 집합을 생성합니다. CMUX는 <a href="https://www.ruby-lang.org">Ruby</a>로 작성되어 있기 때문에 당연히 Ruby 코드로 생성하겠죠.</p>

<h3 id="명령어-실행-단계">명령어 실행 단계</h3>
<p>생성한 명령어 또는 명령어 집합을 실행합니다. 이때 명령어 집합을 병렬로 실행할 수 있는 인터페이스가 필요할 수 있는데, CMUX는 이를 위해 <a href="https://github.com/tmux/tmux/wiki">TMUX</a>를 사용합니다.</p>

<p>그럼, 이해를 돕기 위해 간단한 예제 코드를 통해 이 과정을 구현해 보겠습니다.</p>

<h2 id="구현-예제">구현 예제</h2>
<h3 id="준비">준비</h3>
<p>CMUX의 아이디어를 구현하기 위해 필요한 두 가지 도구인 <a href="https://github.com/junegunn/fzf">FZF</a>, <a href="https://github.com/tmux/tmux/wiki">TMUX</a>를 설치합니다. OS X 유저라면 homebrew로 간단하게 설치할 수 있습니다.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew install tmux fzf
</code></pre></div></div>

<p>CMUX는 Ruby로 작성되어 있지만, 이 예제에서는 쉘 스크립트로 간단하게 구현해 보겠습니다. 그리고 쉘에서 JSON 포맷으로 제공되는 <a href="http://cloudera.github.io/cm_api/apidocs/v16/">Cloudera Manager REST API</a>를 편하게 활용할 수 있도록 <a href="https://stedolan.github.io/jq/">jq</a>를 설치하겠습니다.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>brew install jq
</code></pre></div></div>

<p>자 이제 준비가 되었으니, 데이터 입력 부분부터 구현해 볼까요?</p>

<h3 id="입력">입력</h3>

<p><a href="http://cloudera.github.io/cm_api/apidocs/v16/">Cloudera Manager REST API</a>를 활용하여, Cloudera Manager에 생성되어 있는 클러스터 정보를 취득하겠습니다.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ CM</span><span class="o">=</span><span class="s2">"test.kakao.cm"</span>
<span class="nv">$ CM_PORT</span><span class="o">=</span><span class="s2">"7180"</span>
<span class="nv">$ CM_API_VER</span><span class="o">=</span><span class="s2">"v14"</span>
<span class="nv">$ CM_USER</span><span class="o">=</span><span class="s2">"hadoop"</span>
<span class="nv">$ CM_USER_PWD</span><span class="o">=</span><span class="s2">"doopy"</span>
<span class="nv">$ RESOURCE</span><span class="o">=</span><span class="s2">"/clusters"</span>
<span class="nv">$ BASE_URL</span><span class="o">=</span><span class="s2">"</span><span class="nv">$CM</span><span class="s2">:</span><span class="nv">$CM_PORT</span><span class="s2">/api/</span><span class="nv">$CM_API_VER</span><span class="s2">"</span>
<span class="nv">$ URL</span><span class="o">=</span><span class="s2">"</span><span class="nv">$BASE_URL$RESOURCE</span><span class="s2">"</span>
<span class="nv">$ </span>curl <span class="nt">-f</span> <span class="nt">-s</span> <span class="nt">-u</span> <span class="s2">"</span><span class="nv">$CM_USER</span><span class="s2">"</span>:<span class="s2">"</span><span class="nv">$CM_USER_PWD</span><span class="s2">"</span> <span class="s2">"</span><span class="nv">$URL</span><span class="s2">"</span>
</code></pre></div></div>

<p>대략 이런 모습의 결과를 확인할 수 있을 것입니다. Cloudera Manager가 없는 환경이라고 낙담하지 않으셔도 됩니다. 다음 단계부터는 아래의 내용을 <code class="highlighter-rouge">clusters.txt</code>로 저장했다고 가정하고 진행하겠습니다.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"items"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
    </span><span class="s2">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"cluster1"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"displayName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Neo"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"version"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"CDH5"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"fullVersion"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"5.3.8"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"maintenanceMode"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w">
    </span><span class="s2">"maintenanceOwners"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">],</span><span class="w">
    </span><span class="s2">"clusterUrl"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"https://www.kakaofriends.com/kr/products/groups/characters/8"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"hostsUrl"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"https://www.kakaofriends.com/kr/products/groups/characters/8"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"entityStatus"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"NONE"</span><span class="w">
  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"cluster2"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"displayName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Ryan"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"version"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"CDH5"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"fullVersion"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"5.11.1"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"maintenanceMode"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="s2">"maintenanceOwners"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">"CLUSTER"</span><span class="w"> </span><span class="p">],</span><span class="w">
    </span><span class="s2">"clusterUrl"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"https://www.kakaofriends.com/kr/products/groups/characters/23"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"hostsUrl"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"https://www.kakaofriends.com/kr/products/groups/characters/23"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"entityStatus"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"GOOD_HEALTH"</span><span class="w">
  </span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"name"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"cluster3"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"displayName"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"Apeach"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"version"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"CDH5"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"fullVersion"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"5.3.8"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"maintenanceMode"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w">
    </span><span class="s2">"maintenanceOwners"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="p">],</span><span class="w">
    </span><span class="s2">"clusterUrl"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"https://www.kakaofriends.com/kr/products/groups/characters/6"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"hostsUrl"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"https://www.kakaofriends.com/kr/products/groups/characters/6"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"entityStatus"</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="s2">"GOOD_HEALTH"</span><span class="w">
  </span><span class="p">}</span><span class="w"> </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<h3 id="검색필터">검색/필터</h3>

<p>호출된 결과를 <code class="highlighter-rouge">jq</code> 명령어를 이용해서 특정 필드만 가져오도록 하겠습니다. 
우리는 “클러스터 이름(<code class="highlighter-rouge">name</code>)”, “클러스터 표시 명(<code class="highlighter-rouge">displayName</code>)”, “클러스터 관리자 페이지 URL(<code class="highlighter-rouge">clusterUrl</code>)”에만 관심이 있습니다.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat </span>clusters.txt <span class="se">\</span>
| jq <span class="nt">-r</span> <span class="s1">'.items[] | [.name, .displayName, .clusterUrl]'</span>
</code></pre></div></div>

<p>잘 걸러졌습니다.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="w">
  </span><span class="s2">"cluster1"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"Neo"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"https://www.kakaofriends.com/kr/products/groups/characters/8"</span><span class="w">
</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="w">
  </span><span class="s2">"cluster2"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"Ryan"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"https://www.kakaofriends.com/kr/products/groups/characters/23"</span><span class="w">
</span><span class="p">]</span><span class="w">
</span><span class="p">[</span><span class="w">
  </span><span class="s2">"cluster3"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"Apeach"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"https://www.kakaofriends.com/kr/products/groups/characters/6"</span><span class="w">
</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>이제, 특정 클러스터를 검색하고 필터링할 수 있도록 하겠습니다.</p>

<p>먼저, 위 결과를 클러스터별로 선택 가능하도록 <code class="highlighter-rouge">jq</code>의 <code class="highlighter-rouge">join</code>문으로 열을 결합합니다.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat </span>clusters.txt <span class="se">\</span>
| jq <span class="nt">-r</span> <span class="s1">'.items[] | [.name, .displayName, .clusterUrl] | join("\t")'</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cluster1   Neo     https://www.kakaofriends.com/kr/products/groups/characters/8
cluster2   Ryan    https://www.kakaofriends.com/kr/products/groups/characters/23
cluster3   Apeach  https://www.kakaofriends.com/kr/products/groups/characters/6
</code></pre></div></div>

<blockquote>
  <p>참고</p>

  <p>CMUX에서는 결과물을 잘 정렬된 테이블 형태로 출력할 수 있도록, 이 부분을 <a href="https://github.com/kakao/cmux/blob/master/lib/cmux/utils/formatter.rb#L7-L31">별도의 모듈</a>로 구현하였습니다.</p>
</blockquote>

<p>내가 원하는 결과를 검색하고 선택할 수 있도록 해 볼까요?</p>

<p><code class="highlighter-rouge">fzf</code> 명령어를 파이프에 연결하겠습니다.</p>
<ul>
  <li><code class="highlighter-rouge">--multi</code>: 다중 선택</li>
  <li><code class="highlighter-rouge">--reverse</code>: 역순 레이아웃, 기본값은 아래에서 위로 정렬합니다.</li>
</ul>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat </span>clusters.txt <span class="se">\</span>
| jq <span class="nt">-r</span> <span class="s1">'.items[] | [.name, .displayName, .clusterUrl] | join("\t")'</span> <span class="se">\</span>
| fzf <span class="nt">--multi</span> <span class="nt">--reverse</span>
</code></pre></div></div>

<p>위 스크립트를 실행하면 아래와 같이 선택 가능한 상태로 FZF가 활성화됩니다.</p>

<p><img src="/files/cmux-fzf01.png" alt="" /></p>

<p>“Ryan”이라는 클러스터 이름을 검색하겠습니다.
“Fuzzy Finder”라는 이름에 걸맞게 아래와 같이 느슨한 검색이 가능합니다. 다양한 검색 옵션이 있으니, <code class="highlighter-rouge">fzf</code>의 <code class="highlighter-rouge">man</code> 페이지를 읽어보시기 바랍니다.</p>

<p><img src="/files/cmux-fzf02.png" alt="" /></p>

<p>이번엔 “Neo”와 “Apeach” 클러스터를 선택하겠습니다. 기본적으로 <code class="highlighter-rouge">tab</code> 키로 선택할 수 있습니다. 전체 선택, 전체 선택 해제 등 다양한 옵션이 있으니, 마찬가지로 <code class="highlighter-rouge">man</code> 페이지를 읽어보시기 바랍니다.</p>

<p><img src="/files/cmux-fzf03.png" alt="" /></p>

<p>최종 선택한 결과는 아래와 같이 문자열로 반환됩니다.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cluster1  Neo     http://test.kakao.cm:7180/cmf/clusterRedirect/cluster
cluster3  Apeach  http://test.kakao.cm:7180/cmf/clusterRedirect/cluster2
</code></pre></div></div>

<h3 id="명령어-생성">명령어 생성</h3>
<p>결과의 마지막 열인 “Cluster URL”을 기본 브라우저로 열 수 있도록 명령어를 만들겠습니다. OS X 환경이라는 가정하에 <code class="highlighter-rouge">open</code> 명령어를 사용합니다.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat </span>clusters.txt <span class="se">\</span>
| jq <span class="nt">-r</span> <span class="s1">'.items[] | [.name, .displayName, .clusterUrl] | join("\t")'</span> <span class="se">\</span>
| fzf <span class="nt">--multi</span> <span class="nt">--reverse</span> <span class="se">\</span>
| awk <span class="s1">'{print "open "$NF}'</span>
</code></pre></div></div>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>open https://www.kakaofriends.com/kr/products/groups/characters/8
open https://www.kakaofriends.com/kr/products/groups/characters/23
</code></pre></div></div>

<h2 id="명령어-실행">명령어 실행</h2>
<p>위에서 생성한 명령어를 실행할 수 있도록 스크립트를 변경하겠습니다.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat </span>clusters.txt <span class="se">\</span>
| jq <span class="nt">-r</span> <span class="s1">'.items[] | [.name, .displayName, .clusterUrl] | join("\t")'</span> <span class="se">\</span>
| fzf <span class="nt">--multi</span> <span class="nt">--reverse</span> <span class="se">\</span>
| awk <span class="s1">'{print "open "$NF}'</span> <span class="se">\</span>
| <span class="o">{</span> <span class="k">while </span><span class="nb">read </span>CMD<span class="p">;</span> <span class="k">do
  </span><span class="nb">eval</span> <span class="s2">"</span><span class="k">${</span><span class="nv">CMD</span><span class="k">}</span><span class="s2">"</span>
<span class="k">done</span> <span class="o">}</span>
</code></pre></div></div>

<p>이 코드를 실행하면 여러분이 선택한 클러스터의 URL이 기본 웹브라우저에서 열릴 것입니다. 이 예제에서는 이해를 돕기 위해 각 카카오 프렌즈의 상품페이지로 이동하도록 URL을 편집해 두었습니다. ^^;</p>

<p>이번엔 조금 더 복잡한 구현을 도전해 볼까요?</p>

<p>웹 브라우저로 각 URL을 열기 전에 TMUX로 선택한 URL의 수만큼 윈도우를 분할한 후 URL 정보를 화면에 출력하도록 스크립트를 보강하겠습니다.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat </span>clusters.txt <span class="se">\</span>
| jq <span class="nt">-r</span> <span class="s1">'.items[] | [.name, .displayName, .clusterUrl] | join("\t")'</span> <span class="se">\</span>
| fzf <span class="nt">--multi</span> <span class="nt">--reverse</span> <span class="se">\</span>
| awk <span class="s1">'{print "echo \""$1": " $NF"\" &amp;&amp; open "$NF";echo -n Press enter to finish.; read"}'</span> <span class="se">\</span>
| <span class="o">{</span> <span class="k">while </span><span class="nb">read </span>CMD<span class="p">;</span> <span class="k">do
 </span>tmux <span class="nt">-2</span> split-window <span class="s2">"</span><span class="k">${</span><span class="nv">CMD</span><span class="k">}</span><span class="s2">"</span>
 tmux <span class="nt">-2</span> <span class="k">select</span><span class="nt">-layout</span> tiled
<span class="k">done</span> <span class="o">}</span> <span class="o">&amp;&amp;</span> tmux setw synchronize-panes on <span class="o">&amp;&amp;</span> <span class="nb">exit</span>
</code></pre></div></div>

<p>위와 같이 실행하면 여러분의 터미널 윈도우가 아래와 같이 분할된 후 URL에 출력되는 것을 확인할 수 있을 것입니다.</p>

<p><img src="/files/cmux-ts.png" alt="" /></p>

<blockquote>
  <p>참고</p>

  <p>CMUX에서는 이 부분이 <a href="https://github.com/kakao/cmux/blob/master/lib/cmux/commands/tmux_window_splitter.rb">tws</a> 라는 별도의 명령어로 보다 정밀한 화면 제어가 가능하도록 구현되어 있습니다.</p>
</blockquote>

<h2 id="맺음말">맺음말</h2>

<p>CMUX를 개발한 후, 지난 1년여 동안 내부적으로 사용하면서 버그를 수정하고 기능을 보강하고 있지만 부끄러울 정도로 부족한 면이 많습니다. 
하지만, CLI에서도 이런 것도 할 수 있다는 아이디어를 공유하고 싶었으며, 더 기발한 아이디어로 CLI가 풍부해지길 기대하면서 오픈 소스로 공개하게 되었습니다.</p>

<ul>
  <li><a href="https://github.com/kakao/cmux">https://github.com/kakao/cmux</a></li>
  <li><a href="https://github.com/kakao/cmux/wiki">https://github.com/kakao/cmux/wiki</a></li>
</ul>

<p>마지막으로 CMUX를 위해 <a href="https://github.com/junegunn/fzf">FZF</a>에 여러가지 기능을 탑재해 주신 <a href="https://github.com/junegunn">jg.choi</a>님께 감사의 말씀을 드립니다.</p>

</div>
  <div id="post-footer">
    
    <a id="post-author" href="/authors/jon.kwon/">
      <div id="author-image" style="background-image:url(/files/authors/jon.kwon.jpg);">
        <span class="sr-only">jon.kwon's profile image</span>
      </div>
      <p id="author-name">jon.kwon</p>
    </a>
    <p id="post-date">2017-07-12 00:00</p>
    <a id="post-more" href="/authors/jon.kwon/">
      <span>Read more posts by this author</span>
    </a>
  </div>
</div>

<div class="container" style="margin-top:25px; padding:0px">
  <a href="https://www.welcomekakao.com" target="_blank"><img src="/files/career2020.jpg" style="width:100%;"></a>
</div>

<div id="post-links" class="container">
  
  
  <div id="post-prev" >
    <div>
      <h3><a href="/2017/01/25/nomad/">오픈소스 간단 리뷰 - nomad : 가벼운 스케쥴러, 강력한 성능</a></h3>
      <p>YOU MIGHT ENJOY</p>
    </div>
  </div>
  
  
  
  <div id="post-next" style="background-image: url(/files/covers/code-festival-round-1.png);" >
    <div>
      <h3><a href="/2017/08/11/code-festival-round-1/">카카오 코드 페스티벌 예선전 이야기</a></h3>
      <p>NEXT POST</p>
    </div>
  </div>
  
</div>

<div id="lightbox">
  <div id="lightbox-image"></div>
</div>

    <div class="clearfix"></div>

    <a href="#" id="back-to-top"></a>
</div>

<div id="footer" class="container-fluid">
    <ul id="links">
        
        <li>
            <a id="link-github" href="http://github.com/kakao" target="_blank">
                <span class="sr-only">github</span>
            </a>
        </li>
        
        
        <li>
            <a id="link-facebook" href="http://facebook.com/nkakao" target="_blank">
                <span class="sr-only">facebook</span>
            </a>
        </li>
        
        
        <li>
            <a id="link-twitter" href="http://twitter.com/kakaodev" target="_blank">
                <span class="sr-only">twitter</span>
            </a>
        </li>
        
        <li>
            <a id="link-rss" href="/rss" target="_blank">
                <span class="sr-only">rss</span>
            </a>
        </li>
    </ul>
    <ul id="footer-menu">
        <li><a href="//www.kakaocorp.com">Kakao</a></li>
        <li><a href="//careers.kakao.com/jobs">Jobs</a></li>
        <li><a href="//privacy.kakaocorp.com">Privacy</a></li>
    </ul>
    <p id="copyright">
        <a href="//www.kakaocorp.com">Copyright &copy; Kakao Corp.</a>
        All rights reserved.
    </p>
</div><!--#footer-->


<script src="/assets/lib/jquery-1.12.0.min.js"></script>
<script src="/assets/lib/jquery.magnific-popup.min.js"></script>
<script src="/assets/js/index.js"></script>
<script src="//developers.kakao.com/sdk/js/kakao.min.js"></script>


<script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date();
        a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
    ga('create', 'UA-72007721-1', 'auto');
    ga('send', 'pageview');
</script>




    <script type='text/javascript'>
   //<![CDATA[
    // 사용할 앱의 JavaScript 키를 설정해 주세요.
    //Kakao.init('65d48e116d8b9409e08960c4800c3017');
    function shareStory(abs_page_url) {
        Kakao.Story.share({
            url: abs_page_url,
            text: '카카오 기술블로그 #개발자 #카카오'
        });
    }
    //]]>
</script>

    
    <script>
window.fbAsyncInit = function() {
  FB.init({
    appId      : '1204347326263800',
    xfbml      : true,
    version    : 'v2.7'
  });
};

(function(d, s, id){
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));
</script>

    

    
    <script>!function (d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https';
        if (!d.getElementById(id)) {
            js = d.createElement(s);
            js.id = id;
            js.src = p + '://platform.twitter.com/widgets.js';
            fjs.parentNode.insertBefore(js, fjs);
        }
    }(document, 'script', 'twitter-wjs');
</script>

    

    
    <script src="https://apis.google.com/js/platform.js" async defer>
    {
        lang: 'ko'
    }
</script>

    

</body>
</html>
